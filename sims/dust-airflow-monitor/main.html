<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dust Collection Airflow Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }
        #p5-container {
            width: 100vw;
            height: 100vh;
        }
        .control-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            max-width: 350px;
        }
        .control-panel h3 {
            margin-bottom: 12px;
            color: #4dd0e1;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        select, button {
            padding: 8px 12px;
            margin: 8px 0;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #2a2a3e;
            color: #eee;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
        }
        select:hover, button:hover {
            background-color: #3a3a4e;
            border-color: #666;
        }
        button.diagnose {
            background-color: #4dd0e1;
            color: #1a1a2e;
            font-weight: bold;
            margin-top: 12px;
        }
        button.diagnose:hover {
            background-color: #80deea;
        }
        .toggle-label {
            display: flex;
            align-items: center;
            margin: 12px 0;
            font-size: 12px;
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            margin-right: 10px;
            background-color: #444;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid #666;
        }
        .toggle-switch.active {
            background-color: #4dd0e1;
        }
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transition: left 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            left: 22px;
        }
        .score-display {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(77, 208, 225, 0.1);
            border-left: 3px solid #4dd0e1;
            font-size: 12px;
            display: none;
        }
        .score-display.visible {
            display: block;
        }
        .diagnosis-text {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 600px;
            font-size: 12px;
            line-height: 1.5;
            color: #ccc;
            display: none;
            z-index: 100;
        }
        .diagnosis-text.visible {
            display: block;
        }
        .diagnosis-text h4 {
            color: #4dd0e1;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .quiz-options {
            position: absolute;
            bottom: 200px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 100;
            display: none;
        }
        .quiz-options.visible {
            display: block;
        }
        .quiz-option {
            padding: 10px;
            margin: 8px 0;
            background-color: #2a2a3e;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .quiz-option:hover {
            background-color: #3a3a4e;
            border-color: #666;
        }
        .quiz-option.correct {
            background-color: #4caf50;
            border-color: #4caf50;
            color: white;
        }
        .quiz-option.incorrect {
            background-color: #f44336;
            border-color: #f44336;
            color: white;
        }
        .scenario-label {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            color: #4dd0e1;
            font-weight: bold;
            display: block;
        }
        .scenario-label.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="p5-container"></div>
    <div class="control-panel">
        <h3>Control Panel</h3>
        <label for="scenario-select">Scenario:</label>
        <select id="scenario-select">
            <option value="normal">Normal Operation</option>
            <option value="blocked">Blocked Branch Duct</option>
            <option value="torn">Torn Filter Bag</option>
            <option value="overloaded">Overloaded Filters</option>
            <option value="slipping">Fan Belt Slipping</option>
        </select>

        <div class="toggle-label">
            <div class="toggle-switch" id="quiz-toggle">
                <div class="toggle-slider"></div>
            </div>
            Quiz Mode
        </div>

        <button class="diagnose" id="diagnose-btn">Diagnose System</button>

        <div class="score-display" id="score-display">
            <strong>Score:</strong> <span id="correct-count">0</span> / <span id="total-count">0</span> correct
        </div>
    </div>

    <div class="scenario-label" id="scenario-label">Normal Operation</div>

    <div class="quiz-options" id="quiz-options">
        <strong style="color: #4dd0e1; font-size: 13px; margin-bottom: 10px; display: block;">What is the fault?</strong>
        <div class="quiz-option" data-option="normal">Normal Operation</div>
        <div class="quiz-option" data-option="blocked">Blocked Branch Duct</div>
        <div class="quiz-option" data-option="torn">Torn Filter Bag</div>
        <div class="quiz-option" data-option="overloaded">Overloaded Filters</div>
        <div class="quiz-option" data-option="slipping">Fan Belt Slipping</div>
    </div>

    <div class="diagnosis-text" id="diagnosis-text"></div>

    <script>
        let currentScenario = 'normal';
        let quizMode = false;
        let showDiagnosis = false;
        let correctCount = 0;
        let totalCount = 0;
        let quizAnswered = false;

        const scenarioData = {
            normal: {
                label: 'Normal Operation',
                collectorDeltaP: 3.5,
                fanAmperage: 72,
                exhaustParticulate: 5,
                branch1Velocity: 4000,
                branch2Velocity: 4100,
                branch3Velocity: 4050,
                branch4Velocity: 3950,
                diagnosis: '<h4>Diagnosis: Normal Operation</h4><p>All sensor readings are within normal operating ranges. Collector ΔP is ideal (3.5 in.w.g.), fan is operating at standard amperage (72% FLA), exhaust particulate is well below alarm threshold, and all branch velocities are consistent around 4000 ft/min.</p>'
            },
            blocked: {
                label: 'Blocked Branch Duct',
                collectorDeltaP: 2.1,
                fanAmperage: 65,
                exhaustParticulate: 8,
                branch1Velocity: 4200,
                branch2Velocity: 0,
                branch3Velocity: 4400,
                branch4Velocity: 4300,
                diagnosis: '<h4>Diagnosis: Blocked Branch Duct (Branch 2)</h4><p>Branch 2 velocity reads zero while other branches increase to compensate. Collector ΔP drops significantly (2.1 in.w.g.) due to reduced system load. Fan amperage decreases as the motor works less. Check Branch 2 for clogs, collapsed duct, or damper issues.</p>'
            },
            torn: {
                label: 'Torn Filter Bag',
                collectorDeltaP: 0.9,
                fanAmperage: 70,
                exhaustParticulate: 62,
                branch1Velocity: 4000,
                branch2Velocity: 4100,
                branch3Velocity: 4050,
                branch4Velocity: 3950,
                diagnosis: '<h4>Diagnosis: Torn Filter Bag</h4><p>Collector ΔP is critically low (0.9 in.w.g.), and exhaust particulate has spiked to 62 mg/m³. This indicates a filter bag tear allowing unfiltered air to bypass the collection. Branch velocities remain normal because the fan can now pull more air through the damaged filter. Replace the filter bag immediately.</p>'
            },
            overloaded: {
                label: 'Overloaded Filters',
                collectorDeltaP: 8.5,
                fanAmperage: 88,
                exhaustParticulate: 28,
                branch1Velocity: 3200,
                branch2Velocity: 3280,
                branch3Velocity: 3240,
                branch4Velocity: 3150,
                diagnosis: '<h4>Diagnosis: Overloaded Filters</h4><p>Collector ΔP is elevated (8.5 in.w.g.) and all branch velocities are reduced by ~20%. Fan amperage is high (88% FLA) as the motor struggles against filter resistance. Exhaust particulate is elevated (28 mg/m³). Clean or replace filter bags to restore system airflow.</p>'
            },
            slipping: {
                label: 'Fan Belt Slipping',
                collectorDeltaP: 3.2,
                fanAmperage: 45,
                exhaustParticulate: 12,
                branch1Velocity: 2600,
                branch2Velocity: 2700,
                branch3Velocity: 2650,
                branch4Velocity: 2550,
                diagnosis: '<h4>Diagnosis: Fan Belt Slipping</h4><p>All branch velocities are reduced uniformly by ~35% (2600-2700 ft/min vs normal 4000 ft/min). Fan amperage is unusually low (45% FLA) despite reduced performance. Collector ΔP remains moderate. Inspect the fan belt for wear, fraying, or glazing and adjust tension or replace as needed.</p>'
            }
        };

        function setup() {
            let container = document.getElementById('p5-container');
            let w = container.clientWidth;
            let h = container.clientHeight;

            let cnv = createCanvas(w, h);
            cnv.parent('p5-container');

            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('scenario-select').addEventListener('change', (e) => {
                currentScenario = e.target.value;
                showDiagnosis = false;
                quizAnswered = false;
                document.getElementById('diagnosis-text').classList.remove('visible');
                document.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.remove('correct', 'incorrect');
                });
            });

            document.getElementById('quiz-toggle').addEventListener('click', () => {
                quizMode = !quizMode;
                document.getElementById('quiz-toggle').classList.toggle('active');
                document.getElementById('score-display').classList.toggle('visible');
                document.getElementById('scenario-label').classList.toggle('hidden');
                showDiagnosis = false;
                document.getElementById('diagnosis-text').classList.remove('visible');
                quizAnswered = false;
            });

            document.getElementById('diagnose-btn').addEventListener('click', () => {
                if (quizMode && !quizAnswered) {
                    document.getElementById('quiz-options').classList.add('visible');
                } else if (!quizMode) {
                    showDiagnosis = true;
                    document.getElementById('diagnosis-text').classList.add('visible');
                }
            });

            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    if (quizAnswered) return;

                    const selected = e.target.dataset.option;
                    const correct = currentScenario === selected;

                    e.target.classList.add(correct ? 'correct' : 'incorrect');

                    document.querySelectorAll('.quiz-option').forEach(opt => {
                        if (opt.dataset.option === currentScenario) {
                            opt.classList.add('correct');
                        }
                    });

                    quizAnswered = true;
                    totalCount++;
                    if (correct) correctCount++;

                    document.getElementById('correct-count').textContent = correctCount;
                    document.getElementById('total-count').textContent = totalCount;
                });
            });

            window.addEventListener('resize', () => {
                let container = document.getElementById('p5-container');
                let w = container.clientWidth;
                let h = container.clientHeight;
                resizeCanvas(w, h);
            });
        }

        function updateScenarioLabel() {
            document.getElementById('scenario-label').textContent = scenarioData[currentScenario].label;
        }

        function drawSystemSchematic() {
            fill(255);
            textSize(14);
            textAlign(LEFT);
            text('System Schematic', 30, 40);

            let schematicY = 70;
            let schematicHeight = height * 0.55;
            let ductWidth = 30;

            // Draw hoods and branch ducts
            let hoods = [
                { x: 80, label: 'Hood 1', velocity: scenarioData[currentScenario].branch1Velocity },
                { x: 240, label: 'Hood 2', velocity: scenarioData[currentScenario].branch2Velocity },
                { x: 400, label: 'Hood 3', velocity: scenarioData[currentScenario].branch3Velocity },
                { x: 560, label: 'Hood 4', velocity: scenarioData[currentScenario].branch4Velocity }
            ];

            // Draw hoods
            hoods.forEach((hood, idx) => {
                drawHood(hood.x, schematicY, hood.label, hood.velocity);
            });

            // Draw branch ducts
            hoods.forEach((hood, idx) => {
                drawBranchDuct(hood.x, schematicY + 50, hood.velocity, 'Branch ' + (idx + 1));
            });

            // Draw main trunk
            let trunkY = schematicY + 150;
            let trunkStartX = 50;
            let trunkEndX = 600;
            drawMainTrunk(trunkStartX, trunkY, trunkEndX, scenarioData[currentScenario].collectorDeltaP);

            // Draw collector box
            let collectorY = trunkY + 80;
            drawCollectorBox(250, collectorY, scenarioData[currentScenario].exhaustParticulate);

            // Draw fan
            let fanY = collectorY + 100;
            drawFan(400, fanY, scenarioData[currentScenario].fanAmperage);
        }

        function drawHood(x, y, label, velocity) {
            let color = getVelocityColor(velocity);
            stroke(color);
            strokeWeight(2);
            noFill();

            // Hood shape
            line(x - 20, y, x - 20, y - 20);
            line(x + 20, y, x + 20, y - 20);
            line(x - 20, y - 20, x + 20, y - 20);

            fill(255);
            textSize(10);
            textAlign(CENTER);
            text(label, x, y + 15);
        }

        function drawBranchDuct(x, y, velocity, label) {
            let color = getVelocityColor(velocity);
            stroke(color);
            strokeWeight(4);
            line(x, y - 50, x, y);

            fill(255);
            textSize(9);
            textAlign(CENTER);
            text(label, x, y + 15);
            text(velocity.toFixed(0) + ' ft/min', x, y + 26);
        }

        function drawMainTrunk(startX, y, endX, deltaP) {
            let color = getDeltaPColor(deltaP);
            stroke(color);
            strokeWeight(8);
            line(startX, y, endX, y);

            // Draw junction points
            for (let i = 0; i < 4; i++) {
                let jx = startX + (endX - startX) * (i + 1) / 4;
                stroke(color);
                strokeWeight(2);
                line(jx, y - 80, jx, y);
            }

            fill(255);
            textSize(11);
            textAlign(CENTER);
            text('Main Trunk', (startX + endX) / 2, y - 15);
        }

        function drawCollectorBox(x, y, particulate) {
            let color = getParticulateColor(particulate);
            stroke(color);
            strokeWeight(2);
            fill(0);
            rect(x - 60, y, 120, 60);

            fill(255);
            textSize(11);
            textAlign(CENTER);
            text('Collector Box', x, y + 25);
            text(particulate.toFixed(1) + ' mg/m³', x, y + 40);
        }

        function drawFan(x, y, amperage) {
            let color = getAmperageColor(amperage);
            stroke(color);
            strokeWeight(2);
            fill(0);
            circle(x, y, 50);

            // Fan blades
            stroke(color);
            strokeWeight(2);
            line(x, y - 15, x, y + 15);
            line(x - 15, y, x + 15, y);

            fill(255);
            textSize(10);
            textAlign(CENTER);
            text('Fan', x, y + 30);
        }

        function drawSensorPanels() {
            let panelStartY = height * 0.65;
            let panelHeight = height * 0.32;
            let panelWidth = width / 4 - 20;
            let panelX = [40, 40 + panelWidth + 20, 40 + 2 * (panelWidth + 20), 40 + 3 * (panelWidth + 20)];

            // Draw background
            noStroke();
            fill(0);
            rect(20, panelStartY - 10, width - 40, panelHeight + 20);

            stroke(100);
            strokeWeight(1);
            noFill();
            rect(20, panelStartY - 10, width - 40, panelHeight + 20);

            // Panel titles
            fill(77, 208, 225);
            textSize(12);
            textAlign(CENTER);
            text('Collector ΔP', panelX[0] + panelWidth / 2, panelStartY + 20);
            text('Fan Motor Amps', panelX[1] + panelWidth / 2, panelStartY + 20);
            text('Exhaust Particulate', panelX[2] + panelWidth / 2, panelStartY + 20);
            text('Branch Velocities', panelX[3] + panelWidth / 2, panelStartY + 20);

            // Draw gauges
            drawDeltaPGauge(panelX[0], panelStartY + 50, panelWidth, scenarioData[currentScenario].collectorDeltaP);
            drawAmperageGauge(panelX[1], panelStartY + 50, panelWidth, scenarioData[currentScenario].fanAmperage);
            drawParticulateGauge(panelX[2], panelStartY + 50, panelWidth, scenarioData[currentScenario].exhaustParticulate);
            drawVelocitiesBars(panelX[3], panelStartY + 50, panelWidth, [
                scenarioData[currentScenario].branch1Velocity,
                scenarioData[currentScenario].branch2Velocity,
                scenarioData[currentScenario].branch3Velocity,
                scenarioData[currentScenario].branch4Velocity
            ]);

            // Update diagnosis text
            document.getElementById('diagnosis-text').innerHTML = scenarioData[currentScenario].diagnosis;
        }

        function drawDeltaPGauge(x, y, w, value) {
            let gaugeRadius = 45;
            let cx = x + w / 2;
            let gaugeY = y + gaugeRadius + 10;

            // Draw gauge background
            stroke(100);
            strokeWeight(2);
            noFill();
            arc(cx, gaugeY, gaugeRadius * 2, gaugeRadius * 2, PI, TWO_PI, CHORD);

            // Draw color zones
            drawGaugeZone(cx, gaugeY, gaugeRadius, PI, PI + HALF_PI * 0.5, color(76, 175, 80)); // Green zone
            drawGaugeZone(cx, gaugeY, gaugeRadius, PI + HALF_PI * 0.5, PI + HALF_PI * 1.2, color(255, 193, 7)); // Yellow
            drawGaugeZone(cx, gaugeY, gaugeRadius, PI + HALF_PI * 1.2, TWO_PI, color(244, 67, 54)); // Red

            // Draw needle
            let normalizedValue = constrain(value / 10, 0, 1);
            let needleAngle = PI + normalizedValue * PI;
            let needleLength = gaugeRadius - 5;
            let needleX = cx + cos(needleAngle) * needleLength;
            let needleY = gaugeY + sin(needleAngle) * needleLength;

            stroke(255);
            strokeWeight(3);
            line(cx, gaugeY, needleX, needleY);
            noStroke();
            fill(255);
            circle(cx, gaugeY, 8);

            // Draw value text
            fill(255);
            textSize(14);
            textAlign(CENTER);
            text(value.toFixed(1) + ' in.w.g', cx, gaugeY + 40);

            // Draw scale
            fill(150);
            textSize(9);
            textAlign(CENTER);
            text('0', cx - gaugeRadius - 5, gaugeY + 5);
            text('10', cx + gaugeRadius + 5, gaugeY + 5);
        }

        function drawGaugeZone(cx, cy, r, startAngle, endAngle, col) {
            stroke(col);
            strokeWeight(8);
            noFill();
            arc(cx, cy, r * 2, r * 2, startAngle, endAngle, CHORD);
        }

        function drawAmperageGauge(x, y, w, value) {
            let barHeight = 80;
            let barWidth = 30;
            let cx = x + w / 2;

            // Draw background bar
            stroke(100);
            strokeWeight(1);
            fill(50);
            rect(cx - barWidth / 2, y, barWidth, barHeight);

            // Draw colored zones
            let greenStart = y + barHeight * 0.4;
            let greenEnd = y + barHeight * 0.85;
            fill(76, 175, 80);
            noStroke();
            rect(cx - barWidth / 2, greenStart, barWidth, greenEnd - greenStart);

            // Draw fill based on value
            let fillHeight = barHeight * (value / 100);
            let fillColor = getAmperageColor(value);
            fill(fillColor);
            rect(cx - barWidth / 2, y + barHeight - fillHeight, barWidth, fillHeight);

            // Draw border
            stroke(100);
            strokeWeight(1);
            noFill();
            rect(cx - barWidth / 2, y, barWidth, barHeight);

            // Draw value text
            fill(255);
            textSize(12);
            textAlign(CENTER);
            text(value.toFixed(0) + '%', cx, y + barHeight + 20);

            // Draw scale markers
            textSize(8);
            fill(150);
            text('0%', cx - 20, y + barHeight + 5);
            text('100%', cx + 20, y + barHeight + 5);
        }

        function drawParticulateGauge(x, y, w, value) {
            let barHeight = 80;
            let barWidth = 30;
            let cx = x + w / 2;

            // Draw background bar
            stroke(100);
            strokeWeight(1);
            fill(50);
            rect(cx - barWidth / 2, y, barWidth, barHeight);

            // Draw colored zones
            let greenEnd = y + barHeight * 0.33;
            let yellowEnd = y + barHeight * 0.66;

            fill(76, 175, 80);
            rect(cx - barWidth / 2, y, barWidth, greenEnd - y);
            fill(255, 193, 7);
            rect(cx - barWidth / 2, greenEnd, barWidth, yellowEnd - greenEnd);
            fill(244, 67, 54);
            rect(cx - barWidth / 2, yellowEnd, barWidth, y + barHeight - yellowEnd);

            // Draw fill based on value (0-100 mg/m³ scale)
            let fillHeight = barHeight * constrain(value / 100, 0, 1);
            let fillColor = getParticulateColor(value);
            fill(fillColor);
            rect(cx - barWidth / 2, y + barHeight - fillHeight, barWidth, fillHeight);

            // Draw border
            stroke(100);
            strokeWeight(1);
            noFill();
            rect(cx - barWidth / 2, y, barWidth, barHeight);

            // Draw value text
            fill(255);
            textSize(12);
            textAlign(CENTER);
            text(value.toFixed(1) + ' mg/m³', cx, y + barHeight + 20);
        }

        function drawVelocitiesBars(x, y, w, velocities) {
            let barHeight = 60;
            let barSpacing = 15;
            let barWidth = (w - barSpacing * 3) / 4;
            let cx = x + w / 2;
            let startX = cx - (barWidth * 4 + barSpacing * 3) / 2;

            velocities.forEach((vel, idx) => {
                let bx = startX + idx * (barWidth + barSpacing);
                let fillHeight = barHeight * constrain(vel / 5000, 0, 1);
                let color = getVelocityColor(vel);

                // Draw background
                stroke(100);
                strokeWeight(1);
                fill(50);
                rect(bx, y, barWidth, barHeight);

                // Draw fill
                fill(color);
                rect(bx, y + barHeight - fillHeight, barWidth, fillHeight);

                // Draw border
                stroke(100);
                strokeWeight(1);
                noFill();
                rect(bx, y, barWidth, barHeight);

                // Label
                fill(255);
                textSize(9);
                textAlign(CENTER);
                text('B' + (idx + 1), bx + barWidth / 2, y + barHeight + 15);

                // Value
                textSize(8);
                fill(150);
                text(vel.toFixed(0), bx + barWidth / 2, y + barHeight + 28);
            });
        }

        function getVelocityColor(velocity) {
            if (velocity >= 3500 && velocity <= 4500) return color(76, 175, 80); // Green
            if (velocity > 4500 || (velocity > 0 && velocity < 3500)) return color(255, 193, 7); // Yellow
            if (velocity === 0) return color(244, 67, 54); // Red
            return color(76, 175, 80);
        }

        function getDeltaPColor(deltaP) {
            if (deltaP >= 2 && deltaP <= 5) return color(76, 175, 80); // Green
            if ((deltaP > 5 && deltaP <= 7) || (deltaP >= 1 && deltaP < 2)) return color(255, 193, 7); // Yellow
            return color(244, 67, 54); // Red
        }

        function getAmperageColor(amperage) {
            if (amperage >= 60 && amperage <= 85) return color(76, 175, 80); // Green
            if (amperage > 85 && amperage <= 95) return color(255, 193, 7); // Yellow
            return color(244, 67, 54); // Red
        }

        function getParticulateColor(particulate) {
            if (particulate <= 10) return color(76, 175, 80); // Green
            if (particulate > 10 && particulate <= 30) return color(255, 193, 7); // Yellow
            return color(244, 67, 54); // Red
        }

        function draw() {
            background(26, 26, 46);

            updateScenarioLabel();
            drawSystemSchematic();
            drawSensorPanels();
        }

        function windowResized() {
            if (document.getElementById('p5-container')) {
                let container = document.getElementById('p5-container');
                let w = container.clientWidth;
                let h = container.clientHeight;
                resizeCanvas(w, h);
            }
        }
    </script>
</body>
</html>
