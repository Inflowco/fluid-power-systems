<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="schema" content="https://dmccreary.github.io/intelligent-textbooks/ns/microsim/v1">
<title>Compressed Air Energy Comparison</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    margin: 0;
    padding: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f0f4f8;
    color: #1a202c;
    line-height: 1.5;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 16px;
  }

  h1 {
    text-align: center;
    font-size: 1.6rem;
    font-weight: 700;
    color: #1a202c;
    margin-bottom: 4px;
    padding-top: 8px;
  }

  .subtitle {
    text-align: center;
    font-size: 0.95rem;
    color: #64748b;
    margin-bottom: 18px;
  }

  /* Controls Panel */
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    justify-content: center;
    align-items: flex-end;
    background: #ffffff;
    border-radius: 12px;
    padding: 18px 24px;
    margin-bottom: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }

  .control-group {
    display: flex;
    flex-direction: column;
    min-width: 160px;
  }

  .control-group label {
    font-size: 0.78rem;
    font-weight: 600;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 6px;
  }

  .control-group input[type="range"] {
    width: 100%;
    accent-color: #3b82f6;
    cursor: pointer;
  }

  .control-group select {
    padding: 7px 10px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 0.9rem;
    background: #fff;
    cursor: pointer;
  }

  .control-value {
    font-size: 0.85rem;
    font-weight: 600;
    color: #1e40af;
    margin-top: 2px;
    text-align: center;
  }

  .toggle-group {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: auto;
  }

  .toggle-group label {
    margin-bottom: 0;
  }

  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #cbd5e1;
    transition: 0.25s;
    border-radius: 24px;
  }

  .toggle-slider::before {
    content: "";
    position: absolute;
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.25s;
    border-radius: 50%;
  }

  .toggle-switch input:checked + .toggle-slider {
    background-color: #3b82f6;
  }

  .toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
  }

  /* Section Headers */
  .section-header {
    font-size: 1.05rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 14px;
    padding-bottom: 6px;
    border-bottom: 2px solid #e2e8f0;
  }

  /* Two-Panel Layout */
  .panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .panel {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }

  /* Compressor Type Cards */
  .compressor-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .compressor-card {
    background: #ffffff;
    border-radius: 10px;
    padding: 14px;
    border-left: 4px solid;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .compressor-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 14px rgba(0,0,0,0.12);
  }

  .compressor-card.reciprocating { border-left-color: #3b82f6; }
  .compressor-card.rotary-screw { border-left-color: #10b981; }
  .compressor-card.rotary-vane { border-left-color: #8b5cf6; }
  .compressor-card.centrifugal { border-left-color: #f59e0b; }

  .compressor-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .compressor-icon {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.72rem;
    font-weight: 700;
    color: #fff;
    flex-shrink: 0;
  }

  .compressor-card.reciprocating .compressor-icon { background: #3b82f6; }
  .compressor-card.rotary-screw .compressor-icon { background: #10b981; }
  .compressor-card.rotary-vane .compressor-icon { background: #8b5cf6; }
  .compressor-card.centrifugal .compressor-icon { background: #f59e0b; }

  .compressor-card-title {
    font-size: 0.88rem;
    font-weight: 700;
    color: #1e293b;
  }

  .data-rows {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .data-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 0;
    border-bottom: 1px solid #f1f5f9;
  }

  .data-row:last-child {
    border-bottom: none;
  }

  .data-label {
    font-size: 0.73rem;
    color: #64748b;
  }

  .data-value {
    font-size: 0.78rem;
    font-weight: 700;
    color: #1e293b;
  }

  .efficiency-bar {
    width: 100%;
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    margin-top: 4px;
    overflow: hidden;
  }

  .efficiency-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.4s ease;
  }

  .compressor-card.reciprocating .efficiency-fill { background: #3b82f6; }
  .compressor-card.rotary-screw .efficiency-fill { background: #10b981; }
  .compressor-card.rotary-vane .efficiency-fill { background: #8b5cf6; }
  .compressor-card.centrifugal .efficiency-fill { background: #f59e0b; }

  /* Mini part-load chart container */
  .mini-chart-container {
    margin-top: 6px;
    height: 50px;
    position: relative;
  }

  .co2-data {
    display: none;
  }

  .co2-data.visible {
    display: flex;
  }

  /* Strategy Cards */
  .strategy-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .strategy-card {
    background: #ffffff;
    border-radius: 10px;
    padding: 14px;
    border-top: 4px solid;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .strategy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 14px rgba(0,0,0,0.12);
  }

  .strategy-card.load-unload { border-top-color: #ef4444; }
  .strategy-card.modulation { border-top-color: #f59e0b; }
  .strategy-card.vfd { border-top-color: #10b981; }
  .strategy-card.vfd-storage { border-top-color: #06b6d4; }

  .strategy-card-icon {
    width: 38px;
    height: 38px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.15rem;
    margin: 0 auto 8px;
  }

  .strategy-card.load-unload .strategy-card-icon { background: #fef2f2; color: #dc2626; }
  .strategy-card.modulation .strategy-card-icon { background: #fffbeb; color: #d97706; }
  .strategy-card.vfd .strategy-card-icon { background: #ecfdf5; color: #059669; }
  .strategy-card.vfd-storage .strategy-card-icon { background: #ecfeff; color: #0891b2; }

  .strategy-card-title {
    font-size: 0.86rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 8px;
  }

  .strategy-data-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 0;
    border-bottom: 1px solid #f1f5f9;
  }

  .strategy-data-row:last-child {
    border-bottom: none;
  }

  .strategy-data-label {
    font-size: 0.72rem;
    color: #64748b;
    text-align: left;
  }

  .strategy-data-value {
    font-size: 0.78rem;
    font-weight: 700;
    color: #1e293b;
    text-align: right;
  }

  .savings-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.74rem;
    font-weight: 700;
    margin-top: 8px;
    width: 100%;
    text-align: center;
  }

  .strategy-card.load-unload .savings-badge { background: #fef2f2; color: #991b1b; }
  .strategy-card.modulation .savings-badge { background: #fffbeb; color: #92400e; }
  .strategy-card.vfd .savings-badge { background: #ecfdf5; color: #065f46; }
  .strategy-card.vfd-storage .savings-badge { background: #ecfeff; color: #155e75; }

  /* Chart Section */
  .chart-section {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }

  .chart-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 4px;
  }

  .chart-subtitle {
    font-size: 0.82rem;
    color: #94a3b8;
    margin-bottom: 14px;
  }

  .chart-wrapper {
    position: relative;
    width: 100%;
    max-height: 380px;
  }

  .best-combo {
    text-align: center;
    margin-top: 14px;
    padding: 10px 16px;
    background: #ecfdf5;
    border-radius: 8px;
    border: 1px solid #a7f3d0;
  }

  .best-combo-label {
    font-size: 0.78rem;
    color: #065f46;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.04em;
    margin-bottom: 2px;
  }

  .best-combo-value {
    font-size: 1rem;
    font-weight: 700;
    color: #047857;
  }

  /* Responsive */
  @media (max-width: 1100px) {
    .panels {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 700px) {
    .compressor-cards {
      grid-template-columns: 1fr;
    }

    .strategy-cards {
      grid-template-columns: 1fr;
    }

    .controls {
      flex-direction: column;
      align-items: stretch;
    }

    .control-group {
      min-width: unset;
    }

    h1 { font-size: 1.3rem; }
    .container { padding: 8px; }
    .panel { padding: 14px; }
    .chart-section { padding: 14px; }
  }
</style>
</head>
<body>

<div class="container">

<h1>Compressed Air Energy Comparison</h1>
<p class="subtitle">Interactive comparison of energy consumption across compressor types and control strategies</p>

<!-- Controls -->
<div class="controls">
  <div class="control-group">
    <label for="systemLoad">Average System Load</label>
    <input type="range" id="systemLoad" min="25" max="100" step="25" value="75">
    <div class="control-value" id="systemLoadValue">75%</div>
  </div>
  <div class="control-group">
    <label for="elecRate">Electricity Rate</label>
    <input type="range" id="elecRate" min="0.08" max="0.25" step="0.01" value="0.12">
    <div class="control-value" id="elecRateValue">$0.12 / kWh</div>
  </div>
  <div class="control-group">
    <label for="opHours">Operating Hours / Year</label>
    <input type="range" id="opHours" min="2000" max="8760" step="500" value="6000">
    <div class="control-value" id="opHoursValue">6,000 hrs</div>
  </div>
  <div class="control-group">
    <label for="systemSize">System Size</label>
    <select id="systemSize">
      <option value="25">25 HP</option>
      <option value="50">50 HP</option>
      <option value="100" selected>100 HP</option>
      <option value="200">200 HP</option>
    </select>
  </div>
  <div class="control-group toggle-group">
    <label for="showCO2">Show CO2 Impact</label>
    <div class="toggle-switch">
      <input type="checkbox" id="showCO2">
      <span class="toggle-slider"></span>
    </div>
  </div>
</div>

<!-- Two-Panel Layout -->
<div class="panels">
  <!-- Left Panel: Compressor Type Energy Comparison -->
  <div class="panel">
    <div class="section-header">Compressor Type Energy Comparison</div>
    <div class="compressor-cards">

      <div class="compressor-card reciprocating">
        <div class="compressor-card-header">
          <div class="compressor-icon">RCP</div>
          <div class="compressor-card-title">Reciprocating</div>
        </div>
        <div class="data-rows">
          <div class="data-row">
            <span class="data-label">Specific Power</span>
            <span class="data-value" id="rcp-sp">22.0 kW/100 CFM</span>
          </div>
          <div class="data-row">
            <span class="data-label">Annual Cost</span>
            <span class="data-value" id="rcp-cost">--</span>
          </div>
          <div class="data-row co2-data" id="rcp-co2-row">
            <span class="data-label">CO2 / Year</span>
            <span class="data-value" id="rcp-co2">--</span>
          </div>
          <div class="data-row">
            <span class="data-label">Efficiency</span>
            <span class="data-value" id="rcp-eff">82%</span>
          </div>
        </div>
        <div class="efficiency-bar"><div class="efficiency-fill" id="rcp-eff-bar" style="width:82%"></div></div>
        <div class="mini-chart-container"><canvas id="rcp-mini"></canvas></div>
      </div>

      <div class="compressor-card rotary-screw">
        <div class="compressor-card-header">
          <div class="compressor-icon">RS</div>
          <div class="compressor-card-title">Rotary Screw</div>
        </div>
        <div class="data-rows">
          <div class="data-row">
            <span class="data-label">Specific Power</span>
            <span class="data-value" id="rs-sp">20.0 kW/100 CFM</span>
          </div>
          <div class="data-row">
            <span class="data-label">Annual Cost</span>
            <span class="data-value" id="rs-cost">--</span>
          </div>
          <div class="data-row co2-data" id="rs-co2-row">
            <span class="data-label">CO2 / Year</span>
            <span class="data-value" id="rs-co2">--</span>
          </div>
          <div class="data-row">
            <span class="data-label">Efficiency</span>
            <span class="data-value" id="rs-eff">85%</span>
          </div>
        </div>
        <div class="efficiency-bar"><div class="efficiency-fill" id="rs-eff-bar" style="width:85%"></div></div>
        <div class="mini-chart-container"><canvas id="rs-mini"></canvas></div>
      </div>

      <div class="compressor-card rotary-vane">
        <div class="compressor-card-header">
          <div class="compressor-icon">RV</div>
          <div class="compressor-card-title">Rotary Vane</div>
        </div>
        <div class="data-rows">
          <div class="data-row">
            <span class="data-label">Specific Power</span>
            <span class="data-value" id="rv-sp">21.5 kW/100 CFM</span>
          </div>
          <div class="data-row">
            <span class="data-label">Annual Cost</span>
            <span class="data-value" id="rv-cost">--</span>
          </div>
          <div class="data-row co2-data" id="rv-co2-row">
            <span class="data-label">CO2 / Year</span>
            <span class="data-value" id="rv-co2">--</span>
          </div>
          <div class="data-row">
            <span class="data-label">Efficiency</span>
            <span class="data-value" id="rv-eff">80%</span>
          </div>
        </div>
        <div class="efficiency-bar"><div class="efficiency-fill" id="rv-eff-bar" style="width:80%"></div></div>
        <div class="mini-chart-container"><canvas id="rv-mini"></canvas></div>
      </div>

      <div class="compressor-card centrifugal">
        <div class="compressor-card-header">
          <div class="compressor-icon">CF</div>
          <div class="compressor-card-title">Centrifugal</div>
        </div>
        <div class="data-rows">
          <div class="data-row">
            <span class="data-label">Specific Power</span>
            <span class="data-value" id="cf-sp">18.5 kW/100 CFM</span>
          </div>
          <div class="data-row">
            <span class="data-label">Annual Cost</span>
            <span class="data-value" id="cf-cost">--</span>
          </div>
          <div class="data-row co2-data" id="cf-co2-row">
            <span class="data-label">CO2 / Year</span>
            <span class="data-value" id="cf-co2">--</span>
          </div>
          <div class="data-row">
            <span class="data-label">Efficiency</span>
            <span class="data-value" id="cf-eff">88%</span>
          </div>
        </div>
        <div class="efficiency-bar"><div class="efficiency-fill" id="cf-eff-bar" style="width:88%"></div></div>
        <div class="mini-chart-container"><canvas id="cf-mini"></canvas></div>
      </div>

    </div>
  </div>

  <!-- Right Panel: Control Strategy Comparison -->
  <div class="panel">
    <div class="section-header">Control Strategy Comparison</div>
    <p style="font-size:0.82rem; color:#64748b; margin-bottom:14px;">Based on a rotary screw compressor at selected load</p>
    <div class="strategy-cards">

      <div class="strategy-card load-unload">
        <div class="strategy-card-icon">&#9881;</div>
        <div class="strategy-card-title">Load / Unload</div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Energy</span>
          <span class="strategy-data-value" id="lu-energy">--</span>
        </div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Cost</span>
          <span class="strategy-data-value" id="lu-cost">--</span>
        </div>
        <div class="strategy-data-row co2-data" id="lu-co2-row">
          <span class="strategy-data-label">CO2 Emissions</span>
          <span class="strategy-data-value" id="lu-co2">--</span>
        </div>
        <div class="savings-badge" id="lu-savings">Baseline</div>
      </div>

      <div class="strategy-card modulation">
        <div class="strategy-card-icon">&#9776;</div>
        <div class="strategy-card-title">Modulation</div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Energy</span>
          <span class="strategy-data-value" id="mod-energy">--</span>
        </div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Cost</span>
          <span class="strategy-data-value" id="mod-cost">--</span>
        </div>
        <div class="strategy-data-row co2-data" id="mod-co2-row">
          <span class="strategy-data-label">CO2 Emissions</span>
          <span class="strategy-data-value" id="mod-co2">--</span>
        </div>
        <div class="savings-badge" id="mod-savings">--</div>
      </div>

      <div class="strategy-card vfd">
        <div class="strategy-card-icon">&#9889;</div>
        <div class="strategy-card-title">VFD</div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Energy</span>
          <span class="strategy-data-value" id="vfd-energy">--</span>
        </div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Cost</span>
          <span class="strategy-data-value" id="vfd-cost">--</span>
        </div>
        <div class="strategy-data-row co2-data" id="vfd-co2-row">
          <span class="strategy-data-label">CO2 Emissions</span>
          <span class="strategy-data-value" id="vfd-co2">--</span>
        </div>
        <div class="savings-badge" id="vfd-savings">--</div>
      </div>

      <div class="strategy-card vfd-storage">
        <div class="strategy-card-icon">&#9879;</div>
        <div class="strategy-card-title">VFD + Storage</div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Energy</span>
          <span class="strategy-data-value" id="vfds-energy">--</span>
        </div>
        <div class="strategy-data-row">
          <span class="strategy-data-label">Annual Cost</span>
          <span class="strategy-data-value" id="vfds-cost">--</span>
        </div>
        <div class="strategy-data-row co2-data" id="vfds-co2-row">
          <span class="strategy-data-label">CO2 Emissions</span>
          <span class="strategy-data-value" id="vfds-co2">--</span>
        </div>
        <div class="savings-badge" id="vfds-savings">--</div>
      </div>

    </div>
  </div>
</div>

<!-- Bottom Panel: Combined Summary Chart -->
<div class="chart-section">
  <div class="chart-title">Combined Summary: Specific Power by Compressor Type and Control Strategy</div>
  <div class="chart-subtitle">Grouped bars show effective specific power (kW/100 CFM); line overlay shows annual cost ($)</div>
  <div class="chart-wrapper">
    <canvas id="mainChart"></canvas>
  </div>
  <div class="best-combo">
    <div class="best-combo-label">Best Combination</div>
    <div class="best-combo-value" id="bestCombo">--</div>
  </div>
</div>

</div><!-- end container -->

<script>
(function() {
  // ========================================================================
  // COMPRESSOR BASE DATA
  // ========================================================================
  // Specific power in kW per 100 CFM at full load (100 psig typical)
  // Efficiency: percentage of input energy converted to useful compression
  var compressors = {
    rcp: {
      name: 'Reciprocating',
      specificPower: 22.0,   // kW per 100 CFM at full load
      efficiency: 82,
      color: 'rgba(59, 130, 246, ALPHA)',
      border: '#3b82f6',
      // Part-load efficiency at 25%, 50%, 75%, 100% load
      // Reciprocating: reasonably efficient at partial loads due to step unloading
      partLoadEff: [70, 78, 81, 82]
    },
    rs: {
      name: 'Rotary Screw',
      specificPower: 20.0,
      efficiency: 85,
      color: 'rgba(16, 185, 129, ALPHA)',
      border: '#10b981',
      // Rotary screw: good full-load, decent partial load
      partLoadEff: [72, 80, 84, 85]
    },
    rv: {
      name: 'Rotary Vane',
      specificPower: 21.5,
      efficiency: 80,
      color: 'rgba(139, 92, 246, ALPHA)',
      border: '#8b5cf6',
      // Rotary vane: drops off more at partial loads
      partLoadEff: [65, 74, 78, 80]
    },
    cf: {
      name: 'Centrifugal',
      specificPower: 18.5,
      efficiency: 88,
      color: 'rgba(245, 158, 11, ALPHA)',
      border: '#f59e0b',
      // Centrifugal: excellent at full load, DRAMATIC cliff below ~60% (surge)
      partLoadEff: [40, 55, 82, 88]
    }
  };

  var compressorKeys = ['rcp', 'rs', 'rv', 'cf'];

  // HP to kW conversion: 1 HP = 0.7457 kW
  var hpToKW = 0.7457;

  // EPA grid average CO2: ~0.86 lbs CO2 per kWh (2023 eGRID)
  var co2PerKwh = 0.86;

  // ========================================================================
  // CONTROL STRATEGY MULTIPLIERS
  // ========================================================================
  // Each returns the fraction of full-load power consumed at a given load fraction

  // Load/Unload: compressor loads to full pressure, then unloads (runs at ~25% power)
  function loadUnloadMultiplier(loadFraction) {
    var unloadedPower = 0.25;
    return loadFraction * 1.0 + (1 - loadFraction) * unloadedPower;
  }

  // Modulation: inlet valve throttles to reduce output -- very inefficient at partial loads
  function modulationMultiplier(loadFraction) {
    // At 25% load: ~48%; at 50%: ~65%; at 75%: ~83%; at 100%: 100%
    return 0.30 + 0.70 * loadFraction;
  }

  // VFD: variable frequency drive adjusts motor speed to match demand
  function vfdMultiplier(loadFraction) {
    // Affinity laws: power proportional to speed^2.5 (practical, with losses)
    // Minimum floor ~8% for VFD electrical losses at minimum speed
    var affinityPower = Math.pow(loadFraction, 2.5);
    return Math.max(affinityPower, 0.08);
  }

  // VFD + Storage: VFD with optimized receiver storage reduces cycling further
  function vfdStorageMultiplier(loadFraction) {
    // Storage smooths demand peaks: ~7% additional savings over VFD alone
    var vfdPower = vfdMultiplier(loadFraction);
    return vfdPower * 0.93;
  }

  var strategies = {
    lu:   { name: 'Load/Unload',   fn: loadUnloadMultiplier },
    mod:  { name: 'Modulation',    fn: modulationMultiplier },
    vfd:  { name: 'VFD',           fn: vfdMultiplier },
    vfds: { name: 'VFD + Storage', fn: vfdStorageMultiplier }
  };

  var strategyKeys = ['lu', 'mod', 'vfd', 'vfds'];

  // ========================================================================
  // DOM REFERENCES
  // ========================================================================
  var loadSlider  = document.getElementById('systemLoad');
  var rateSlider  = document.getElementById('elecRate');
  var hoursSlider = document.getElementById('opHours');
  var sizeSelect  = document.getElementById('systemSize');
  var co2Toggle   = document.getElementById('showCO2');

  var loadVal  = document.getElementById('systemLoadValue');
  var rateVal  = document.getElementById('elecRateValue');
  var hoursVal = document.getElementById('opHoursValue');

  var mainChart = null;
  var miniCharts = {};

  // ========================================================================
  // FORMATTING HELPERS
  // ========================================================================
  function formatNumber(n) {
    return Math.round(n).toLocaleString('en-US');
  }

  function formatCurrency(n) {
    return '$' + Math.round(n).toLocaleString('en-US');
  }

  function formatCO2(lbs) {
    if (lbs >= 2000) {
      return (lbs / 2000).toFixed(1) + ' tons';
    }
    return formatNumber(lbs) + ' lbs';
  }

  // ========================================================================
  // MINI PART-LOAD CHARTS (one per compressor card)
  // ========================================================================
  function createMiniCharts() {
    var loadPoints = ['25%', '50%', '75%', '100%'];

    for (var i = 0; i < compressorKeys.length; i++) {
      var key = compressorKeys[i];
      var comp = compressors[key];
      var ctx = document.getElementById(key + '-mini').getContext('2d');

      miniCharts[key] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: loadPoints,
          datasets: [{
            data: comp.partLoadEff,
            backgroundColor: comp.color.replace('ALPHA', '0.6'),
            borderColor: comp.border,
            borderWidth: 1,
            borderRadius: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: function(items) {
                  return items[0].label + ' load';
                },
                label: function(context) {
                  return context.parsed.y + '% efficiency';
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              grid: { display: false },
              ticks: { font: { size: 8 }, color: '#94a3b8' }
            },
            y: {
              display: false,
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }
  }

  // ========================================================================
  // MAIN COMPUTATION
  // ========================================================================
  function compute() {
    var loadPct = parseInt(loadSlider.value);
    var loadFraction = loadPct / 100;
    var rate = parseFloat(rateSlider.value);
    var annualHours = parseInt(hoursSlider.value);
    var systemHP = parseInt(sizeSelect.value);
    var showCO2 = co2Toggle.checked;

    // System rated power in kW
    var systemKW = systemHP * hpToKW;

    // Update slider display values
    loadVal.textContent = loadPct + '%';
    rateVal.textContent = '$' + rate.toFixed(2) + ' / kWh';
    hoursVal.textContent = formatNumber(annualHours) + ' hrs';

    // Size efficiency factor: larger systems are slightly more efficient
    var sizeFactor = 1.0;
    if (systemHP === 25)  sizeFactor = 1.08;
    if (systemHP === 50)  sizeFactor = 1.03;
    if (systemHP === 100) sizeFactor = 1.00;
    if (systemHP === 200) sizeFactor = 0.96;

    // ── LEFT PANEL: Compressor Type Cards ──
    for (var i = 0; i < compressorKeys.length; i++) {
      var key = compressorKeys[i];
      var comp = compressors[key];

      // Adjusted specific power for this system size
      var adjSP = comp.specificPower * sizeFactor;

      // Full-load annual energy and cost for this system
      var fullLoadEnergy = systemKW * annualHours;
      var annualCost = fullLoadEnergy * rate;
      var annualCO2 = fullLoadEnergy * co2PerKwh;

      // Look up part-load efficiency based on current load setting
      var loadIndex = Math.round(loadFraction * 3);
      if (loadIndex > 3) loadIndex = 3;
      var currentEff = comp.partLoadEff[loadIndex];

      // Update card display
      document.getElementById(key + '-sp').textContent = adjSP.toFixed(1) + ' kW/100 CFM';
      document.getElementById(key + '-cost').textContent = formatCurrency(annualCost);
      document.getElementById(key + '-co2').textContent = formatCO2(annualCO2);
      document.getElementById(key + '-eff').textContent = currentEff + '%';
      document.getElementById(key + '-eff-bar').style.width = currentEff + '%';

      // Color-code the efficiency value: green = high, red = low
      var effEl = document.getElementById(key + '-eff');
      if (currentEff >= 80) {
        effEl.style.color = '#059669';
      } else if (currentEff >= 65) {
        effEl.style.color = '#d97706';
      } else {
        effEl.style.color = '#dc2626';
      }
    }

    // ── RIGHT PANEL: Control Strategy Cards ──
    // Based on a rotary screw compressor (most common industrial choice)
    var stratResults = {};
    for (var j = 0; j < strategyKeys.length; j++) {
      var sKey = strategyKeys[j];
      var strat = strategies[sKey];
      var powerMult = strat.fn(loadFraction);
      var energy = systemKW * powerMult * annualHours;
      var cost = energy * rate;
      var co2 = energy * co2PerKwh;
      stratResults[sKey] = { energy: energy, cost: cost, co2: co2, mult: powerMult };
    }

    // Update strategy cards with values
    var baselineEnergy = stratResults.lu.energy;

    for (var k = 0; k < strategyKeys.length; k++) {
      var sk = strategyKeys[k];
      var sr = stratResults[sk];

      document.getElementById(sk + '-energy').textContent = formatNumber(sr.energy) + ' kWh';
      document.getElementById(sk + '-cost').textContent = formatCurrency(sr.cost);
      document.getElementById(sk + '-co2').textContent = formatCO2(sr.co2);

      if (sk === 'lu') {
        document.getElementById(sk + '-savings').textContent = 'Baseline';
      } else {
        var savingsPct = ((baselineEnergy - sr.energy) / baselineEnergy * 100);
        if (savingsPct < 0) {
          document.getElementById(sk + '-savings').textContent =
            Math.abs(savingsPct).toFixed(0) + '% more than baseline';
        } else {
          document.getElementById(sk + '-savings').textContent =
            savingsPct.toFixed(0) + '% savings vs baseline';
        }
      }
    }

    // ── CO2 Visibility ──
    var co2Rows = document.querySelectorAll('.co2-data');
    for (var m = 0; m < co2Rows.length; m++) {
      if (showCO2) {
        co2Rows[m].classList.add('visible');
      } else {
        co2Rows[m].classList.remove('visible');
      }
    }

    // ── BOTTOM PANEL: Combined Summary Chart ──
    updateMainChart(loadFraction, rate, annualHours, systemKW, sizeFactor);
  }

  // ========================================================================
  // COMBINED SUMMARY CHART
  // ========================================================================
  function updateMainChart(loadFraction, rate, annualHours, systemKW, sizeFactor) {
    var ctx = document.getElementById('mainChart').getContext('2d');

    // X-axis labels: compressor types
    var labels = ['Reciprocating', 'Rotary Screw', 'Rotary Vane', 'Centrifugal'];

    // For each compressor type x each strategy, calculate:
    //   Effective specific power = base SP * (strategy power mult / load fraction) * surge penalty
    //   Annual cost = systemKW * powerMult * surgePenalty * hours * rate
    var luData = [], modData = [], vfdData = [], vfdsData = [];
    var luCostData = [], modCostData = [], vfdCostData = [], vfdsCostData = [];

    var bestCost = Infinity;
    var bestComboStr = '';

    for (var i = 0; i < compressorKeys.length; i++) {
      var key = compressorKeys[i];
      var comp = compressors[key];
      var adjSP = comp.specificPower * sizeFactor;

      // Centrifugal surge penalty below ~60% load
      var surgePenalty = 1.0;
      if (key === 'cf' && loadFraction < 0.60) {
        // Centrifugal compressors must blow off or recirculate below surge point
        surgePenalty = 1.0 + (0.60 - loadFraction) * 2.5;
      }

      for (var j = 0; j < strategyKeys.length; j++) {
        var sKey = strategyKeys[j];
        var strat = strategies[sKey];
        var powerMult = strat.fn(loadFraction);

        // Effective specific power: kW per 100 CFM of air actually delivered
        var effectiveSP;
        if (loadFraction > 0) {
          effectiveSP = adjSP * (powerMult / loadFraction) * surgePenalty;
        } else {
          effectiveSP = adjSP;
        }

        // Annual cost for this combination
        var annualCost = systemKW * powerMult * surgePenalty * annualHours * rate;

        // Distribute to the correct arrays
        var spVal = parseFloat(effectiveSP.toFixed(1));
        var costVal = Math.round(annualCost);

        if (sKey === 'lu')   { luData.push(spVal);   luCostData.push(costVal); }
        if (sKey === 'mod')  { modData.push(spVal);   modCostData.push(costVal); }
        if (sKey === 'vfd')  { vfdData.push(spVal);   vfdCostData.push(costVal); }
        if (sKey === 'vfds') { vfdsData.push(spVal);  vfdsCostData.push(costVal); }

        // Track best combination (lowest annual cost)
        if (annualCost < bestCost) {
          bestCost = annualCost;
          bestComboStr = comp.name + ' + ' + strat.name +
            ' (' + formatCurrency(annualCost) + '/yr)';
        }
      }
    }

    // Update best combination banner
    document.getElementById('bestCombo').textContent = bestComboStr;

    // ── Build chart datasets ──
    var chartData = {
      labels: labels,
      datasets: [
        {
          label: 'Load/Unload (kW/100 CFM)',
          data: luData,
          backgroundColor: 'rgba(239, 68, 68, 0.7)',
          borderColor: 'rgba(239, 68, 68, 1)',
          borderWidth: 1,
          order: 2
        },
        {
          label: 'Modulation (kW/100 CFM)',
          data: modData,
          backgroundColor: 'rgba(245, 158, 11, 0.7)',
          borderColor: 'rgba(245, 158, 11, 1)',
          borderWidth: 1,
          order: 2
        },
        {
          label: 'VFD (kW/100 CFM)',
          data: vfdData,
          backgroundColor: 'rgba(16, 185, 129, 0.7)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 1,
          order: 2
        },
        {
          label: 'VFD + Storage (kW/100 CFM)',
          data: vfdsData,
          backgroundColor: 'rgba(6, 182, 212, 0.7)',
          borderColor: 'rgba(6, 182, 212, 1)',
          borderWidth: 1,
          order: 2
        },
        {
          label: 'Load/Unload Cost ($)',
          data: luCostData,
          type: 'line',
          borderColor: '#dc2626',
          backgroundColor: 'rgba(220, 38, 38, 0.1)',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: '#dc2626',
          fill: false,
          yAxisID: 'y1',
          order: 1
        },
        {
          label: 'Modulation Cost ($)',
          data: modCostData,
          type: 'line',
          borderColor: '#d97706',
          backgroundColor: 'rgba(217, 119, 6, 0.1)',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: '#d97706',
          fill: false,
          yAxisID: 'y1',
          order: 1
        },
        {
          label: 'VFD Cost ($)',
          data: vfdCostData,
          type: 'line',
          borderColor: '#059669',
          backgroundColor: 'rgba(5, 150, 105, 0.1)',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: '#059669',
          fill: false,
          yAxisID: 'y1',
          order: 1
        },
        {
          label: 'VFD + Storage Cost ($)',
          data: vfdsCostData,
          type: 'line',
          borderColor: '#0891b2',
          backgroundColor: 'rgba(8, 145, 178, 0.1)',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: '#0891b2',
          fill: false,
          yAxisID: 'y1',
          order: 1
        }
      ]
    };

    // ── Calculate axis maximums ──
    var allSP = luData.concat(modData, vfdData, vfdsData);
    var allCost = luCostData.concat(modCostData, vfdCostData, vfdsCostData);
    var maxSP = Math.max.apply(null, allSP) * 1.15;
    var maxCost = Math.max.apply(null, allCost) * 1.15;
    maxSP = Math.ceil(maxSP / 5) * 5;
    maxCost = Math.ceil(maxCost / 5000) * 5000;
    if (maxCost < 5000) maxCost = 5000;

    // ── Create or update chart ──
    if (mainChart) {
      mainChart.data = chartData;
      mainChart.options.scales.y.max = maxSP;
      mainChart.options.scales.y1.max = maxCost;
      mainChart.update();
    } else {
      mainChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 12,
                font: { size: 10 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  var label = context.dataset.label || '';
                  if (context.dataset.yAxisID === 'y1') {
                    return label + ': $' + Math.round(context.parsed.y).toLocaleString();
                  }
                  return label + ': ' + context.parsed.y.toFixed(1) + ' kW/100 CFM';
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 11, weight: 'bold' } }
            },
            y: {
              position: 'left',
              beginAtZero: true,
              max: maxSP,
              title: {
                display: true,
                text: 'Specific Power (kW/100 CFM)',
                font: { size: 11, weight: 'bold' }
              },
              ticks: {
                callback: function(v) { return v.toFixed(0); },
                font: { size: 10 }
              }
            },
            y1: {
              position: 'right',
              beginAtZero: true,
              max: maxCost,
              grid: { drawOnChartArea: false },
              title: {
                display: true,
                text: 'Annual Cost ($)',
                font: { size: 11, weight: 'bold' }
              },
              ticks: {
                callback: function(v) { return '$' + v.toLocaleString(); },
                font: { size: 10 }
              }
            }
          }
        }
      });
    }
  }

  // ========================================================================
  // EVENT LISTENERS
  // ========================================================================
  loadSlider.addEventListener('input', compute);
  rateSlider.addEventListener('input', compute);
  hoursSlider.addEventListener('input', compute);
  sizeSelect.addEventListener('change', compute);
  co2Toggle.addEventListener('change', compute);

  // Resize handling
  window.addEventListener('resize', function() {
    if (mainChart) mainChart.resize();
    for (var key in miniCharts) {
      if (miniCharts[key]) miniCharts[key].resize();
    }
  });

  // ========================================================================
  // INITIALIZE
  // ========================================================================
  createMiniCharts();
  compute();
})();
</script>

</body>
</html>
